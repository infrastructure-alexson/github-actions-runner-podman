version: '3.9'

###############################################################################
# GitHub Actions Self-Hosted Runner - Docker Compose Configuration
# 
# Prerequisites:
#   - If running as non-root user (rootless Podman):
#     See: doc/ROOTLESS-PODMAN-SETUP.md for configuration steps
#   - User must have permission to write to home directory
#   - Podman/Docker socket must be accessible
#
# Usage:
#   docker-compose up -d
#   docker-compose down
#
# Environment (Required):
#   - GITHUB_REPOSITORY: Repository (e.g., owner/repo)
#   - GITHUB_TOKEN: Registration token from GitHub
#   - RUNNER_NAME: Runner display name (default: runner-01)
#   - RUNNER_LABELS: Comma-separated labels (default: podman,linux,amd64)
#
# Environment (Optional):
#   - RUNNER_WORKDIR: Working directory (default: /home/runner/_work)
#   - RUNNER_CPUS: CPU limit (default: 2)
#   - RUNNER_MEMORY: Memory limit (default: 4G)
#
# Example - System Podman:
#   export GITHUB_REPOSITORY=owner/repo
#   export GITHUB_TOKEN=ghs_xxxxx
#   export RUNNER_NAME=runner-01
#   export RUNNER_LABELS=podman,linux,amd64
#   docker-compose up -d
#
# Example - Rootless Podman as 'gha' user:
#   export DOCKER_HOST=unix:///run/user/1000/podman/podman.sock
#   export GITHUB_REPOSITORY=owner/repo
#   export GITHUB_TOKEN=ghs_xxxxx
#   docker-compose up -d
#
# For rootless Podman troubleshooting:
#   See: doc/ROOTLESS-PODMAN-SETUP.md
###############################################################################

services:
  github-runner:
    image: docker.io/salexson/github-action-runner:latest
    container_name: github-runner
    hostname: github-runner
    
    # SELinux: Disable label checking for this container only
    # This allows the runner to work with SELinux enforcing on the host
    # See: doc/HOST-SELINUX-FIX.md for details
    security_opt:
      - label=disable
    
    # Restart policy
    restart: unless-stopped
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 5
      window: 60s
    
    # Environment variables
    environment:
      # Required - choose one:
      # For repo runner:
      GITHUB_REPOSITORY: ${GITHUB_REPOSITORY:-}
      # For org runner:
      GITHUB_ORG: ${GITHUB_ORG:-}
      
      # GitHub token from .env (matches env.example)
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      RUNNER_NAME: ${RUNNER_NAME:-runner-01}
      RUNNER_LABELS: ${RUNNER_LABELS:-podman,linux,amd64}
      
      # Optional
      RUNNER_WORKDIR: ${RUNNER_WORKDIR:-/home/runner/_work}
      RUNNER_GROUPS: ${RUNNER_GROUPS:-default}
      RUNNER_ALLOW_RUNASROOT: ${RUNNER_ALLOW_RUNASROOT:-true}
      
      # System
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
    
    # Volume mounts
    volumes:
      # Essential: Podman/Docker socket for container operations
      # For rootless Podman (gha user UID 984): Use user socket
      # Set: export DOCKER_HOST=unix:///run/user/984/podman/podman.sock
      # Or: export DOCKER_HOST=unix:///run/user/$(id -u)/podman/podman.sock
      # Then docker-compose will use the socket specified in DOCKER_HOST
      - /run/user/984/podman/podman.sock:/var/run/docker.sock:ro
      
      # Essential: Working directory for workflow files
      - ${WORK_DIR:-.}/runner-work:/home/runner/_work
      
      # Recommended: Runner configuration (persistent state)
      - ${CONFIG_DIR:-.}/runner-config:/home/runner/.runner
      
      # Optional: SSH keys for git operations
      # - ~/.ssh:/home/runner/.ssh:ro
      
      # Optional: Cache directory
      # - ${CACHE_DIR:-.}/runner-cache:/home/runner/.cache
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: ${RUNNER_CPUS:-2}
          memory: ${RUNNER_MEMORY:-4G}
        reservations:
          cpus: ${RUNNER_CPUS_RESERVE:-1}
          memory: ${RUNNER_MEMORY_RESERVE:-2G}
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "runner=github-action-runner"
    
    # Labels for identification
    labels:
      - "app=github-action-runner"
      - "version=1.0.0"
      - "managed=true"
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'Runner.Server' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Platform specification (for multi-arch builds)
    platform: linux/amd64

  # Optional: Additional runner instance for parallel workloads
  # Uncomment to enable
  # github-runner-2:
  #   extends: github-runner
  #   container_name: github-runner-2
  #   hostname: github-runner-2
  #   environment:
  #     <<: *default-environment
  #     RUNNER_NAME: runner-02
  #     RUNNER_LABELS: podman,linux,amd64,parallel
  #   volumes:
  #     - /var/run/podman/podman.sock:/var/run/podman/podman.sock
  #     - ./runner-work-2:/home/runner/_work
  #     - ./runner-config-2:/home/runner/.runner

networks:
  default:
    name: github-runner-network
    driver: bridge

volumes:
  # Named volumes (optional)
  runner-work:
    driver: local
  runner-config:
    driver: local

